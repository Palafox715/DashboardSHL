<!DOCTYPE html>
<html lang='es'>
<head>
<meta charset='utf-8'/>
<meta name='viewport' content='width=device-width, initial-scale=1'/>
<title>Leaderboard ‚Äî Dark Neon BG + CoD Rank-Up</title>
<style>
  /* Variables de Color (Dark Neon Blue/Purple) */
  :root{
    --vh: 1vh;
    --from:#7B2EFA; /* Neon Purple */
    --to:#2EFAEB;   /* Neon Cyan/Blue */
    --dark-bg: #0A0A0A; /* Fondo casi negro */
    --ink:#E0E0E0;  /* Texto gris claro para fondo oscuro */
    /* Glass Dark: Transparencia oscura para la base */
    --glass: rgba(0,0,0, .55);
    --glass-strong: rgba(0,0,0, .75);
    --neon-blue: #44CCFF;
    --neon-purple: #FF44CC;
    --glow-blue: rgba(44, 204, 255, .6);
    --glow-purple: rgba(255, 68, 204, .5);
  }
  /* ===== DARK TRON-LIKE BACKGROUND (Black base) ===== */
  html,body{
    margin:0;
    min-height:100%; /* Permite crecer si el contenido es mayor que 100vh */
    width:100%;
    background:var(--dark-bg); /* Fondo oscuro */
    color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    overflow-x: hidden; /* Evita el scroll horizontal */
    overflow-y: auto;   /* Permite el scroll vertical */
  }
  body::before, body::after{
    content:""; position:fixed; inset:-20%;
    /* Efecto de part√≠culas/glow sutil en cian y p√∫rpura sobre negro */
    background: radial-gradient(40% 40% at 20% 20%, var(--glow-blue), transparent),
                radial-gradient(35% 35% at 80% 10%, rgba(255,255,255,.20), transparent),
                radial-gradient(30% 30% at 50% 90%, var(--glow-purple), transparent);
    z-index:0; pointer-events:none; mix-blend-mode:lighten; animation:float 22s linear infinite;
  }
  body::after{ animation-direction:reverse; animation-duration:27s; opacity:.7; }
  @keyframes float{ 0%{transform:translate3d(0,0,0)} 50%{transform:translate3d(2%, -2%, 0)} 100%{transform:translate3d(0,0,0)} }

  #board{
    position:relative; z-index:1;
    width:100vw;
    min-height:100vh;
    padding:calc(1.2*var(--vh)) calc(1.6*var(--vh)); box-sizing:border-box;
    /* Fondo del tablero sutilmente oscuro */
    background: radial-gradient(ellipse at top, #1a0a2e 0%, var(--dark-bg) 100%);
    display:flex;flex-direction:column;gap:calc(0.8*var(--vh));
  }
  
  /* Contenedor flexible para el t√≠tulo y el contador total */
  .top-header-flex{
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
  }

  /* Estilo del contador de Total Diario */
  #dailyTotalDisplay{
    background: var(--glass-strong);
    padding: 8px 16px;
    border-radius: 10px;
    border: 1px solid var(--neon-blue);
    box-shadow: 0 0 15px var(--glow-blue);
    text-align: right;
    flex-shrink: 0;
  }
  #dailyTotalDisplay .label{
    font-size: calc(1.4*var(--vh));
    font-weight: 600;
    color: var(--neon-blue);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    text-shadow: 0 0 5px var(--glow-blue);
  }
  #dailyTotalDisplay .value{
    font-size: calc(3.0*var(--vh));
    font-weight: 900;
    color: var(--neon-purple);
    line-height: 1;
    filter: drop-shadow(0 0 8px var(--glow-purple));
  }

  h2{
    margin:0;text-align:left;font-weight:900;letter-spacing:.3px;
    font-size:calc(4.0*var(--vh)); line-height:1.1;
    /* Drop shadow neon azul para el t√≠tulo */
    filter: drop-shadow(0 0 8px var(--neon-blue));
  }
  .chips{
    display:flex;gap:calc(.6*var(--vh));flex-wrap:wrap;
    justify-content:center;margin-top:calc(-.3*var(--vh));
  }
  .chip{
    padding:calc(.35*var(--vh)) calc(.8*var(--vh));
    border-radius:999px;
    background:var(--glass); /* Glass Dark */
    backdrop-filter: blur(6px);
    border:1px solid rgba(255,255,255,.2);
    font-weight:800;font-size:calc(1.5*var(--vh));
    box-shadow: 0 6px 16px rgba(0,0,0,.3) inset, 0 1px 0 rgba(255,255,255,.1);
  }

  .table-wrap{ flex:1; min-height:0; position:relative; }
  table{
    width:100%;
    min-width: 500px;
    border-collapse:separate; border-spacing:0 10px;
    table-layout:fixed; font-size:calc(1.7*var(--vh));
  }
  thead th{
    position:sticky; top:0; z-index:2;
    background:var(--glass-strong); /* Glass Strong Dark */
    backdrop-filter: blur(6px);
    text-transform:uppercase; letter-spacing:.3px;
    font-size:calc(1.6*var(--vh)); font-weight:900; padding:calc(.6*var(--vh)) calc(0.9*var(--vh));
    border-radius:10px;
    border:1px solid rgba(255,255,255,.15);
  }
  th.col-rank, td.col-rank { width:9%; text-align:center; }
  th.col-agent,td.col-agent{ width:30%; text-align:left; }
  th.col-today,td.col-today{ width:12%; text-align:center; }
  th.col-day,  td.col-day  { width:7%;  text-align:center; }
  th.col-total,td.col-total{ width:12%; text-align:center; }

  tbody td{
    background: var(--glass); /* Glass Dark para las celdas */
    border-top:1px solid rgba(255,255,255,.05);
    border-bottom:1px solid rgba(255,255,255,.05);
    padding:calc(.7*var(--vh)) calc(0.9*var(--vh));
  }
  tbody tr td:first-child{ border-left:1px solid rgba(255,255,255,.05); border-top-left-radius:14px; border-bottom-left-radius:14px; }
  tbody tr td:last-child { border-right:1px solid rgba(255,255,255,.05); border-top-right-radius:14px; border-bottom-right-radius:14px; }
  tbody tr{ transition: transform .25s ease, box-shadow .25s ease; }
  /* Efecto glow en hover */
  tbody tr:hover{ transform: translateY(-2px); box-shadow:0 0 18px var(--glow-blue); background: rgba(0,0,0,.8); }

  .agent-wrap{ display:flex; align-items:center; gap:12px; min-width:0; }
  .avatar{
    flex:0 0 auto; width:44px; height:44px; border-radius:50%;
    /* Avatar con degradado neon */
    background: linear-gradient(135deg, var(--neon-blue), var(--neon-purple)); 
    border:1px solid rgba(0,0,0,.08);
    display:grid; place-items:center;
    font-weight:900; font-size:14px; letter-spacing:.5px;
    color:var(--dark-bg); /* Texto oscuro sobre el color neon */
    text-transform:uppercase;
    box-shadow: 0 4px 14px rgba(0,0,0,.4);
  }
  .name{ font-weight:900; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

  .bar{ position:relative; height:22px; border-radius:999px; background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.06); overflow:hidden; }
  /* BARRA TODAY: Neon Blue */
  .bar > .fill{ 
    position:absolute; left:0; top:0; bottom:0; width:0%; 
    background:linear-gradient(90deg, var(--neon-blue), #0099EE); 
    box-shadow: 0 0 16px var(--glow-blue); /* Glow azul */
    transition: width .8s ease; 
  }
  /* BARRA TOTAL: Neon Purple */
  .bar.total > .fill{ 
    background:linear-gradient(90deg, var(--neon-purple), #EE00AA); 
    box-shadow: 0 0 16px var(--glow-purple); /* Glow p√∫rpura */
  }
  .bar .value{ position:relative; z-index:1; font-weight:900; font-size:90%; color:var(--dark-bg); text-shadow: 0 0 5px var(--ink); }

  .spark{ position:relative; height:18px; border-radius:8px; background:rgba(255,255,255,.15); border:1px solid rgba(255,255,255,.08);
          overflow:hidden; display:grid; place-items:center; font-weight:800; font-size:85%; }
  .spark .f{ position:absolute; left:0; top:0; bottom:0; width:0%; background:linear-gradient(90deg, rgba(255,255,255,.75), rgba(255,255,255,.15)); transition:width .6s ease; }

  #meta{ display:flex;justify-content:flex-start;align-items:center; font-weight:800; font-size:calc(1.5*var(--vh)); }

  /* ===== Medal styles (Dark Neon) ===== */
  .medal{
    display:inline-grid; place-items:center;
    width:38px; height:38px; border-radius:50%;
    margin-right:8px; font-weight:1000; font-size:16px; line-height:1;
    border:1px solid rgba(255,255,255,.1);
    box-shadow: 0 0 10px rgba(0,0,0,.6), inset 0 0 16px rgba(255,255,255,.15);
    color:var(--dark-bg);
  }
  .gold  { background:linear-gradient(180deg,#FF6BFF,#E035D0); box-shadow: 0 0 10px var(--glow-purple); }
  .silver{ background:linear-gradient(180deg,#6BFFFF,#35E0E0); box-shadow: 0 0 10px var(--glow-blue); }
  .bronze{ background:linear-gradient(180deg,#B089FF,#7B44FF); box-shadow: 0 0 10px rgba(123, 46, 250, .5); }
  .rankwrap{ display:flex; align-items:center; justify-content:center; gap:6px; }

  /* ===== CoD Overlay (10s) - Dark Neon Acentos ===== */
  #overlay.cod{position:fixed;inset:0;display:none;place-items:center;z-index:999;
    background: radial-gradient(900px 700px at 50% 40%, rgba(0,0,0,.2), rgba(0,0,0,.9) 60%, rgba(0,0,0,.96) 100%);}
  #overlay .burst{
    position:absolute; inset:0; pointer-events:none; opacity:.3;
    background:repeating-conic-gradient(from 0deg, var(--glow-blue) 0deg, transparent 6deg 12deg, var(--glow-blue) 18deg);
    mask: radial-gradient(ellipse at center, black 0%, transparent 60%);
    animation:spin 6s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  #card{
    position:relative; padding:calc(4*var(--vh)) calc(6*var(--vh)); border-radius:calc(2.2*var(--vh));
    background:linear-gradient(180deg, #0f1417, #141b1f);
    border:2px solid var(--neon-blue); 
    color:#fff;
    text-align:center; animation:pop .45s ease-out;
    box-shadow:0 0 50px rgba(0,0,0,.8), inset 0 0 28px var(--glow-blue);
  }
  .badge{
    display:inline-grid; place-items:center;
    width:110px; height:110px; margin:0 auto calc(1.0*var(--vh));
    border-radius:50%;
    border:2px solid var(--neon-blue); 
    box-shadow:0 0 0 2px #1b1b1b, 0 12px 28px rgba(0,0,0,.7), inset 0 0 28px var(--glow-blue);
    color:var(--dark-bg);
    font-weight:1000; font-size:40px; text-shadow:0 1px 0 #fff8;
    background: radial-gradient(circle at 50% 35%, #ffffff22, transparent 60%),
                linear-gradient(180deg, #A8F6FF, #4CE0F2);
  }
  .badge.gold{
    border-color:var(--neon-purple);
    background: radial-gradient(circle at 50% 35%, #ffffff22, transparent 60%),
                linear-gradient(180deg,#ff80ff,#f24cff);
    box-shadow:0 0 0 2px #1b1b1b, 0 12px 28px rgba(0,0,0,.7), inset 0 0 28px var(--glow-purple);
  }
  .badge.silver{
    border-color:var(--neon-blue);
    background: radial-gradient(circle at 50% 35%, #ffffff22, transparent 60%),
                linear-gradient(180deg,#80ffff,#4ce0f2);
    box-shadow:0 0 0 2px #1b1b1b, 0 12px 28px rgba(0,0,0,.7), inset 0 0 28px var(--glow-blue);
  }
  .badge.bronze{
    border-color:#7B44FF;
    background: radial-gradient(circle at 50% 35%, #ffffff22, transparent 60%),
                linear-gradient(180deg,#c099ff,#9966ff);
  }
  #who{font:1000 calc(7.6*var(--vh))/1.02 system-ui;letter-spacing:.6px;margin-bottom:calc(.3*var(--vh));}
  #metaText{font:900 calc(2.4*var(--vh))/1.2 system-ui;margin-top:calc(.2*var(--vh)); color:var(--neon-blue);}
  #rankLine{ margin-top:calc(.8*var(--vh)); font:1000 calc(3.6*var(--vh))/1 system-ui; display:flex; gap:12px; justify-content:center; align-items:center; }
  .delta{ font:1000 calc(2.0*var(--vh))/1 system-ui; padding:.2em .6em; border-radius:10px; border:1px solid rgba(255,255,255,.2); }
  .delta.up{ color:var(--neon-blue); }
  .delta.down{ color:var(--neon-purple); }
  .position{ padding:.2em .6em; border-radius:10px; font-weight:1000; border:1px solid rgba(255,255,255,.25); color:var(--neon-blue); box-shadow:0 0 18px var(--glow-blue) inset; }

  @keyframes pop{from{transform:scale(.86);opacity:0}50%{transform:scale(1.02)}100%{transform:scale(1);opacity:1}}
  .confetti{position:absolute;top:-10vh;width:10px;height:16px;opacity:0;animation:fall 10s linear forwards}
  @keyframes fall{0%{transform:translateY(-10vh) rotate(0deg);opacity:0}10%{opacity:1}100%{transform:translateY(120vh) rotate(880deg);opacity:0}}


  /* ========================================================= */
  /* === MOBILE OPTIMIZATION (Card View) === */
  /* ========================================================= */
  @media (max-width: 768px) {
    /* Ajustes generales */
    #board { padding: 15px; gap: 10px; }
    .top-header-flex { flex-direction: column; align-items: stretch; }
    #dailyTotalDisplay { width: 100%; text-align: center; margin-top: 10px; }
    .chips { margin-top: 10px; }
    h2 { text-align: center; font-size: 3em; }

    /* Ocultar la cabecera de la tabla y desactivar el layout fijo */
    table { table-layout: auto; min-width: unset; border-spacing: 0; }
    thead { display: none; }
    
    tbody, tr, td { display: block; width: 100%; }

    /* Estilo de tarjeta para cada fila */
    tbody tr { 
      margin-bottom: 12px; 
      border-radius: 14px; 
      padding: 12px; 
      /* Borde y sombra para la tarjeta */
      border: 1px solid rgba(44, 204, 255, .2);
      box-shadow: 0 0 10px rgba(0,0,0,.5);
      background: rgba(0,0,0,.6); 
      transform: none !important; /* Desactiva hover transform */
    }

    /* Estilo de las celdas - simulan filas dentro de la tarjeta */
    tbody td { 
      padding: 6px 0; 
      border: none !important; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      background: none !important;
      border-radius: 0 !important;
    }

    /* Ocultar las columnas diarias para evitar scroll horizontal */
    th.col-day, td.col-day { display: none; }

    /* Asegurar que Agent y Rank tengan espacio */
    th.col-rank, td.col-rank { width: auto; }
    th.col-agent, td.col-agent { width: auto; }
    th.col-today, td.col-today { width: auto; }
    th.col-total, td.col-total { width: auto; }

    /* A√±adir etiquetas visibles a las columnas principales */
    td.col-rank::before { content: 'Rank'; font-weight: 600; opacity: 0.6; margin-right: 10px; }
    td.col-agent::before { content: 'Agent'; font-weight: 600; opacity: 0.6; margin-right: 10px; }
    td.col-today::before { content: 'Today'; font-weight: 600; opacity: 0.6; margin-right: 10px; }
    td.col-total::before { content: 'Total'; font-weight: 600; opacity: 0.6; margin-right: 10px; }
    
    /* El nombre del agente necesita estar en la parte superior */
    .agent-wrap { display: flex; align-items: center; gap: 10px; }
    .agent-wrap .avatar { width: 36px; height: 36px; font-size: 12px; }
    .agent-wrap .name { font-weight: 900; font-size: 1.1em; }
    
    /* Asegurar que las barras se vean bien */
    .bar { height: 18px; flex-grow: 1; margin-left: 10px; }
    .bar .value { color: var(--ink); text-shadow: none; font-size: 90%; }

    /* Arreglar el rankwrap para que se vea bien como etiqueta */
    .rankwrap { justify-content: flex-end; }
    .medal { margin-right: 0; }
  }
</style>
</head>
<body>
<div id='board'>
  <div class='top-header-flex'> 
    <h2>üèÅ Leaderboard</h2>
    <!-- Contador de Total de Hoy (Daily Sales Total) -->
    <div id='dailyTotalDisplay'>
      <div class='label'>Total Diario (Today)</div>
      <div class='value' id='totalTodayValue'>0</div>
    </div>
  </div>

  <div class='chips'>
    <div id='chipWeekly' class='chip'>Week: ‚Äî</div>
    <div id='chipDaily' class='chip'>Daily: ‚Äî</div>
  </div>

  <div class='table-wrap'>
    <table id='tbl'>
      <thead>
        <tr>
          <th class='col-rank'>#</th>
          <th class='col-agent'>Agent</th>
          <th class='col-today'>Today</th>
          <th class='col-day'>Wed</th>
          <th class='col-day'>Thu</th>
          <th class='col-day'>Fri</th>
          <th class='col-day'>Sat</th>
          <th class='col-day'>Mon</th>
          <th class='col-day'>Tue</th>
          <th class='col-total'>Total</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id='meta'>
    <div id='diag'>Loading‚Ä¶</div>
  </div>
</div>

<!-- CoD Overlay (10s) sobre fondo oscuro -->
<div id='overlay' class='cod'>
  <div class='burst'></div>
  <div id='card'>
    <div class='badge'>‚òÖ</div>
    <div id='who'>Agent</div>
    <div id='metaText'>just passed ‚Äî today! üéâ</div>
    <div id='rankLine'>
      <span class='delta' id='deltaBadge'>‚ñ≤ +1</span>
      <span class='position' id='posBadge'>#1</span>
    </div>
  </div>
</div>

<script>
function setVHVar(){ const vh=window.innerHeight*0.01; document.documentElement.style.setProperty('--vh', `${vh}px`); }
setVHVar(); window.addEventListener('resize', setVHVar);

/* IDs y API */
const API_KEY        = "AIzaSyDwOqp2uizZol2et6Uqi7CnntW9Hkrinjg";
const WEEKLY_SHEETID = "1xNrDZ6uXUS0XMU3033SALOPPORgyjQomH68W2GyTAUo";
const DAILY_ID_RAW   = "1MeGKl3Qok84NymsXnuHuA4reL_l9Y1SqqLuejIMeaUA";

const TIMEZONE       = "America/Tijuana";
const DAILY_REFRESH  = 12000;          // refresco m√°s frecuente
const WEEKLY_REFRESH = 5*60*1000;

let ALL_DATA=[]; 
let PREV_T=new Map(), PREV_R=new Map(), INITIALIZED=false;

function diag(t, cls){ document.getElementById('diag').innerHTML = `<span class="${cls||''}">${t}</span>`; }
function setChipWeekly(t){ document.getElementById('chipWeekly').textContent = `Week: ${t}`; }
function setChipDaily(t){ document.getElementById('chipDaily').textContent = `Daily: ${t}`; }
function getLocalDate(){ const s=new Date().toLocaleString('en-US',{timeZone:TIMEZONE}); return new Date(s); }
function isoWeek(d){ const x=new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); const n=x.getUTCDay()||7; x.setUTCDate(x.getUTCDate()+4-n); const y=new Date(Date.UTC(x.getUTCFullYear(),0,1)); return {week:Math.ceil((((x-y)/86400000)+1)/7), year:x.getUTCFullYear()}; }
function weeksInISOYear(y){ const d=new Date(Date.UTC(y,11,31)); const day=d.getUTCDay(); return (day===4 || (d.getUTCDate()===31 && day===3))?53:52; }
function computeWeeklyTabName(){
  const url=new URL(window.location.href); const override=url.searchParams.get('weeklyTab'); if(override) return override;
  const local=getLocalDate(); const hrs=local.getHours(); const dow=local.getDay(); const iw=isoWeek(local); let w=iw.week;
  const afterCut=(dow>4)||(dow===4&&hrs>=14); if(afterCut){ w++; const mx=weeksInISOYear(iw.year); if(w>mx){w=1;} }
  return `W${w}`;
}
const emoji=/[\u{1F1E6}-\u{1F1FF}\u{1F300}-\u{1FAFF}\u{1F900}-\u{1F9FF}\u{2600}-\u{27BF}\u{FE0F}]/gu;
function normName(s){ return (s||"").replace(emoji,"").normalize('NFD').replace(/[\u0300-\u036f]/g,"").replace(/[^\x20-\x7E]/g,"").replace(/\s{2,}/g," ").trim().toUpperCase(); }
function normID(s){ return (s||"").toString().trim(); }

/* fetch con cache-busting */
async function fetchSafeJSON(url, {tries=4, baseDelay=700} = {}) {
  let lastErr;
  for (let i = 0; i < tries; i++) {
    try {
      const r = await fetch(url, {
        cache: 'no-store',
        headers: {
          'Cache-Control': 'no-cache, no-store, max-age=0',
          'Pragma': 'no-cache'
        },
      });
      if (r.ok) return await r.json();

      const text = await r.text();
      if (r.status === 429 || (r.status >= 500 && r.status < 600)) {
        const jitter = Math.random() * 250;
        await new Promise(res => setTimeout(res, baseDelay * Math.pow(2, i) + jitter));
        continue;
      }
      throw new Error(`HTTP ${r.status} ‚Ä¢ ${text.slice(0,180)}`);
    } catch (e) {
      lastErr = e;
      const jitter = Math.random() * 250;
      await new Promise(res => setTimeout(res, baseDelay * Math.pow(2, i) + jitter));
    }
  }
  throw lastErr || new Error('fetchSafeJSON: unknown');
}
async function readWeeklyTab(weeklyTab){
  const ranges=[`${weeklyTab}!A3:C96`,`${
weeklyTab}!D3:D96`,`${
weeklyTab}!F3:F96`,`${
weeklyTab}!H3:H96`,`${
weeklyTab}!J3:J96`,`${
weeklyTab}!L3:L96`,`${
weeklyTab}!N3:N96`,`${
weeklyTab}!O3:O96`].map(encodeURIComponent);
  const url=`https://sheets.googleapis.com/v4/spreadsheets/${WEEKLY_SHEETID}/values:batchGet?`+ranges.map(r=>`ranges=${r}`).join("&")+`&valueRenderOption=UNFORMATTED_VALUE&key=${API_KEY}`;
  const j=await fetchSafeJSON(url); const vr=j.valueRanges||[];
  const base=vr[0]?.values||[]; const toCol=v=>(v?.values||[]).map(r=>(r[0]??"").toString().trim());
  const d=toCol(vr[1]), f=toCol(vr[2]), h=toCol(vr[3]), jv=toCol(vr[4]), l=toCol(vr[5]), n=toCol(vr[6]), oT=toCol(vr[7]);
  const len=Math.max(base.length,d.length,f.length,h.length,jv.length,l.length,n.length,oT.length);
  const out=[];
  for(let i=0;i<len;i++){
    const id=normID(base[i]?.[0]??""); const name=(base[i]?.[1]??"").toString().trim();
    if(!id && !name) continue;
    out.push({ id,idKey:id, name, nameKey:normName(name),
      wed:parseInt(d[i]||0), thu:parseInt(f[i]||0), fri:parseInt(h[i]||0),
      sat:parseInt(jv[i]||0), mon:parseInt(l[i]||0), tue:parseInt(n[i]||0),
      total:parseInt(oT[i]||0), today:0 });
  }
  out.sort((a,b)=>(b.total||0)-(a.total||0));
  return out;
}
function fmtDailyTab(dt){ const m=new Intl.DateTimeFormat('en-US',{month:'short',timeZone:TIMEZONE}).format(dt); const dd=new Intl.DateTimeFormat('en-US',{day:'2-digit',timeZone:TIMEZONE}).format(dt); return `${m} ${dd}`; }
function getDailyTabCandidates(){
  const url=new URL(window.location.href); const o=url.searchParams.get('dailyTab'); if(o) return [o];
  const now=getLocalDate(); const y=new Date(now.getTime()-86400000); return [fmtDailyTab(now), fmtDailyTab(y)];
}
async function readDailyApproved(){
  const rangesFor=tab=>([`${tab}!A2:A70`,`${tab}!B2:B70`,`${tab}!C2:C70`,`${tab}!E2:E70`,`${tab}!F2:F70`,`${tab}!G2:G70`].map(encodeURIComponent));
  const tabs=getDailyTabCandidates();
  const DAILY_IDS=[DAILY_ID_RAW];
  for(const id of DAILY_IDS){
    for(const tab of tabs){
      const url=`https://sheets.googleapis.com/v4/spreadsheets/${id}/values:batchGet?`+rangesFor(tab).map(r=>`ranges=${r}`).join("&")+`&valueRenderOption=UNFORMATTED_VALUE&key=${API_KEY}`;
      try{
        const j=await fetchSafeJSON(url); const vr=j.valueRanges||[];
        const A=vr[0]?.values||[], B=vr[1]?.values||[], C=vr[2]?.values||[];
        const E=vr[3]?.values||[], F=vr[4]?.values||[], G=vr[5]?.values||[];
        const mapByName=new Map(); const mapByID=new Map();
        function addPair(nmCell,idCell,valCell){
          const nm=(nmCell?.[0]??"").toString(); const id=(idCell?.[0]??"").toString().trim(); const v=parseInt((valCell?.[0]??0))||0;
          if(nm.trim()){ const nk=normName(nm); mapByName.set(nk,(mapByName.get(nk)||0)+v); }
          if(id){ mapByID.set(id,(mapByID.get(id)||0)+v); }
        }
        const rowsFK=Math.max(A.length,B.length,C.length); for(let i=0;i<rowsFK;i++) addPair(A[i],B[i],C[i]);
        const rowsRG=Math.max(E.length,F.length,G.length); for(let i=0;i<rowsRG;i++) addPair(E[i],F[i],G[i]);
        return {id, tab, mapByName, mapByID};
      }catch(e){ /* intenta siguiente tab */ }
    }
  }
  return {id:DAILY_IDS[0], tab:tabs[0], mapByName:new Map(), mapByID:new Map()};
}

function updateTotalDisplay(total){
  document.getElementById('totalTodayValue').textContent = total.toLocaleString('en-US');
}

function renderList(list){
  const tbody=document.querySelector("#tbl tbody"); tbody.innerHTML="";
  
  const maxToday=Math.max(1, ...list.map(p=>p.today||0)); 
  const maxTotal=Math.max(1, ...list.map(p=>p.total||0));
  const toPct=(v,max)=>Math.max(3, Math.min(100, Math.round((v/max)*100)));
  
  list.forEach((p,i)=>{
    const rowIndex=i;
    const today=p.today||0, total=p.total||0;

    let medalHTML='';
    if (rowIndex===0) medalHTML = `<span class="medal gold" title="1st">ü•á</span>`;
    else if (rowIndex===1) medalHTML = `<span class="medal silver" title="2nd">ü•à</span>`;
    else if (rowIndex===2) medalHTML = `<span class="medal bronze" title="3rd">ü•â</span>`;

    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td class="col-rank">
        <div class="rankwrap">
          ${medalHTML}
          <span>${rowIndex+1}</span>
        </div>
      </td>
      <td class="col-agent">
        <div class="agent-wrap"><div class="avatar">${(p.name||'').split(' ').map(x=>x[0]||'').join('').slice(0,2).toUpperCase()}</div><div class="name" title="${p.name}">${p.name}</div></div>
      </td>
      <td class="col-today">
        <div class="bar today">
          <div class="fill" style="width:0%"></div>
          <div class="value">${today}</div>
        </div>
      </td>
      <td class="col-day">${p.wed||0}</td>
      <td class="col-day">${p.thu||0}</td>
      <td class="col-day">${p.fri||0}</td>
      <td class="col-day">${p.sat||0}</td>
      <td class="col-day">${p.mon||0}</td>
      <td class="col-day">${p.tue||0}</td>
      <td class="col-total">
        <div class="bar total">
          <div class="fill" style="width:0%"></div>
          <div class="value">${total}</div>
        </div>
      </td>
    `;
    tbody.appendChild(tr);

    // Animaci√≥n de barras
    setTimeout(()=>{
      tr.querySelector('.bar.today > .fill').style.width = toPct(today, maxToday) + '%';
      tr.querySelector('.bar.total > .fill').style.width = toPct(total, maxTotal) + '%';
    }, 50);

    // Detecci√≥n de rangos cambiados para el overlay
    if(INITIALIZED && today > 0){
      const prevTotal = PREV_T.get(p.idKey) || 0;
      const prevRank  = PREV_R.get(p.idKey);
      const currentRank = rowIndex + 1;

      if(total > prevTotal && (prevRank === undefined || currentRank < prevRank)){
        showOverlay(p.name, today, currentRank, prevRank);
      }
    }
  });

  // Guardar estado actual para el siguiente ciclo
  PREV_T = new Map(list.map(p => [p.idKey, p.total]));
  PREV_R = new Map(list.map((p, i) => [p.idKey, i + 1])); 

  // No hay renderDots
}

function showOverlay(name, todayScore, currentRank, prevRank){
  const overlay=document.getElementById('overlay');
  const who=document.getElementById('who');
  const metaText=document.getElementById('metaText');
  const deltaBadge=document.getElementById('deltaBadge');
  const posBadge=document.getElementById('posBadge');
  const badge=overlay.querySelector('.badge');

  let deltaTxt = '';
  let badgeCls = '';
  const rankDelta = (prevRank === undefined) ? '+0' : (prevRank - currentRank);

  if(rankDelta > 0){
    deltaTxt = `‚ñ≤ +${rankDelta}`;
    deltaBadge.className = 'delta up';
  } else if (rankDelta < 0){
    deltaTxt = `‚ñº ${rankDelta}`;
    deltaBadge.className = 'delta down';
  } else {
    deltaTxt = `‚Äî`;
    deltaBadge.className = 'delta';
  }

  if (currentRank===1) badgeCls = 'gold';
  else if (currentRank===2) badgeCls = 'silver';
  else if (currentRank===3) badgeCls = 'bronze';

  who.textContent = name;
  metaText.textContent = `just passed ${todayScore} today! üéâ`;
  deltaBadge.textContent = deltaTxt;
  posBadge.textContent = `#${currentRank}`;
  badge.className = `badge ${badgeCls}`;

  overlay.style.display = 'grid';
  setTimeout(() => overlay.style.display = 'none', 10000);
  createConfetti(15);
}

function createConfetti(count) {
  const overlay = document.getElementById('overlay');
  for (let i = 0; i < count; i++) {
    const c = document.createElement('div');
    c.className = 'confetti';
    c.style.backgroundColor = `hsl(${Math.random() * 360}, 70%, 70%)`;
    c.style.left = `${Math.random() * 100}vw`;
    c.style.animationDelay = `${Math.random() * 1.5}s`;
    c.style.opacity = '1';
    overlay.appendChild(c);
    setTimeout(() => c.remove(), 10000);
  }
}

async function updateData(){
  diag('Updating data...', 'pulse');
  const weeklyTab=computeWeeklyTabName();
  setChipWeekly(weeklyTab);

  const [weeklyData, dailyData] = await Promise.all([
    readWeeklyTab(weeklyTab),
    readDailyApproved()
  ]);
  
  setChipDaily(dailyData.tab);
  
  // Merge daily scores into weekly structure
  const tempMap = new Map();
  weeklyData.forEach(p => tempMap.set(p.idKey, p));
  
  dailyData.mapByName.forEach((score, nameKey) => {
    let agent = weeklyData.find(p => p.nameKey === nameKey);
    if (agent) {
      agent.today = score;
    }
  });
  
  dailyData.mapByID.forEach((score, idKey) => {
    let agent = tempMap.get(idKey);
    if (agent) {
      agent.today = score;
    }
  });

  // Re-sort the merged data by total + today score
  weeklyData.sort((a, b) => {
    const totalA = (a.total||0) + (a.today||0);
    const totalB = (b.total||0) + (b.today||0);
    if (totalB !== totalA) return totalB - totalA;
    return (b.today||0) - (a.today||0);
  });

  // Filter out agents with 0 total score if not in the top 3 and if initialized
  ALL_DATA = weeklyData.filter((p, i) => i < 3 || (p.total||0) > 0 || (p.today||0) > 0);
  
  // Calculate total TODAY score and update display
  const totalToday = ALL_DATA.reduce((sum, p) => sum + (p.today || 0), 0);
  updateTotalDisplay(totalToday);

  diag(`Updated ${new Date().toLocaleTimeString('en-US', {timeZone: TIMEZONE, hour12: false})} (${weeklyTab})`);
  INITIALIZED = true;
}

// Funci√≥n de inicializaci√≥n
(async function init(){
  await updateData();
  renderList(ALL_DATA); // Renderiza la lista completa

  // Se mantiene el refresco de datos
  setInterval(updateData, DAILY_REFRESH); 
})();
</script>
</body>
</html>
