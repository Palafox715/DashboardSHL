<!DOCTYPE html>
<html lang='es'>
<head>
<meta charset='utf-8'/>
<meta name='viewport' content='width=device-width, initial-scale=1'/>
<title>Leaderboard ‚Äî TRON BG + CoD Rank-Up</title>
<style>
  :root{
    --vh: 1vh;
    --from:#B4DB61; --to:#06BBA3; --ink:#0b1a13;
    --glass: rgba(255,255,255,.38);
    --glass-strong: rgba(255,255,255,.55);
  }
  /* ===== LIGHT TRON-LIKE BACKGROUND (green gradient) ===== */
  html,body{margin:0;height:100%;width:100%;background:#fff;color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;overflow:hidden;}
  body::before, body::after{
    content:""; position:fixed; inset:-20%;
    background: radial-gradient(40% 40% at 20% 20%, rgba(255,255,255,.35), transparent),
                radial-gradient(35% 35% at 80% 10%, rgba(255,255,255,.25), transparent),
                radial-gradient(30% 30% at 50% 90%, rgba(255,255,255,.18), transparent);
    z-index:0; pointer-events:none; mix-blend-mode:soft-light; animation:float 22s linear infinite;
  }
  body::after{ animation-direction:reverse; animation-duration:27s; opacity:.7; }
  @keyframes float{ 0%{transform:translate3d(0,0,0)} 50%{transform:translate3d(2%, -2%, 0)} 100%{transform:translate3d(0,0,0)} }

  #board{
    position:relative; z-index:1;
    width:100vw;height:100vh; padding:calc(1.2*var(--vh)) calc(1.6*var(--vh)); box-sizing:border-box;
    background:linear-gradient(135deg,var(--from),var(--to));
    display:flex;flex-direction:column;gap:calc(0.8*var(--vh));
  }

  h2{
    margin:0;text-align:center;font-weight:900;letter-spacing:.3px;
    font-size:calc(4.0*var(--vh)); line-height:1.1;
    filter: drop-shadow(0 1px 0 rgba(0,0,0,.1));
  }
  .chips{
    display:flex;gap:calc(.6*var(--vh));flex-wrap:wrap;
    justify-content:center;margin-top:calc(-.3*var(--vh));
  }
  .chip{
    padding:calc(.35*var(--vh)) calc(.8*var(--vh));
    border-radius:999px;
    background:var(--glass);
    backdrop-filter: blur(6px);
    border:1px solid rgba(255,255,255,.35);
    font-weight:800;font-size:calc(1.5*var(--vh));
    box-shadow: 0 6px 16px rgba(0,0,0,.08) inset, 0 1px 0 rgba(255,255,255,.4);
  }

  .table-wrap{ flex:1; min-height:0; position:relative; }
  table{
    width:100%; height:100%;
    border-collapse:separate; border-spacing:0 10px;
    table-layout:fixed; font-size:calc(1.7*var(--vh));
  }
  thead th{
    position:sticky; top:0; z-index:2;
    background:var(--glass-strong);
    backdrop-filter: blur(6px);
    text-transform:uppercase; letter-spacing:.3px;
    font-size:calc(1.6*var(--vh)); font-weight:900; padding:calc(.6*var(--vh)) calc(0.9*var(--vh));
    border-radius:10px;
    border:1px solid rgba(0,0,0,.08);
  }
  th.col-rank, td.col-rank { width:9%; text-align:center; }
  th.col-agent,td.col-agent{ width:30%; text-align:left; }
  th.col-today,td.col-today{ width:12%; text-align:center; }
  th.col-day,  td.col-day  { width:7%;  text-align:center; }
  th.col-total,td.col-total{ width:12%; text-align:center; }

  tbody td{
    background: rgba(255,255,255,.30);
    border-top:1px solid rgba(0,0,0,.06);
    border-bottom:1px solid rgba(0,0,0,.06);
    padding:calc(.7*var(--vh)) calc(0.9*var(--vh));
  }
  tbody tr td:first-child{ border-left:1px solid rgba(0,0,0,.06); border-top-left-radius:14px; border-bottom-left-radius:14px; }
  tbody tr td:last-child { border-right:1px solid rgba(0,0,0,.06); border-top-right-radius:14px; border-bottom-right-radius:14px; }
  tbody tr{ transition: transform .25s ease, box-shadow .25s ease; }
  tbody tr:hover{ transform: translateY(-2px); box-shadow:0 10px 24px rgba(0,0,0,.10); }

  .agent-wrap{ display:flex; align-items:center; gap:12px; min-width:0; }
  .avatar{
    flex:0 0 auto; width:44px; height:44px; border-radius:50%;
    background: linear-gradient(135deg, #ffffffcc, #ffffff55);
    border:1px solid rgba(0,0,0,.08);
    display:grid; place-items:center;
    font-weight:900; font-size:14px; letter-spacing:.5px;
    color:#0b1a13; text-transform:uppercase;
    box-shadow: 0 4px 14px rgba(0,0,0,.08);
  }
  .name{ font-weight:900; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

  .bar{ position:relative; height:22px; border-radius:999px; background:rgba(255,255,255,.38); border:1px solid rgba(0,0,0,.06); overflow:hidden; }
  .bar > .fill{ position:absolute; left:0; top:0; bottom:0; width:0%; background:linear-gradient(90deg, #0cfaa1, #06bba3); box-shadow: 0 0 16px rgba(12,250,161,.45); transition: width .8s ease; }
  .bar.total > .fill{ background:linear-gradient(90deg, #86b7ff, #00b4d8); box-shadow: 0 0 16px rgba(0,180,216,.35); }
  .bar .value{ position:relative; z-index:1; font-weight:900; font-size:90%; }

  .spark{ position:relative; height:18px; border-radius:8px; background:rgba(255,255,255,.42); border:1px solid rgba(0,0,0,.06);
          overflow:hidden; display:grid; place-items:center; font-weight:800; font-size:85%; }
  .spark .f{ position:absolute; left:0; top:0; bottom:0; width:0%; background:linear-gradient(90deg, rgba(255,255,255,.75), rgba(255,255,255,.15)); transition:width .6s ease; }

  #meta{ display:flex;justify-content:space-between;align-items:center; font-weight:800; font-size:calc(1.5*var(--vh)); }
  .dots{ display:flex; gap:8px; align-items:center; }
  .dot{ width:8px; height:8px; border-radius:999px; background:rgba(255,255,255,.6); opacity:.55; }
  .dot.on{ opacity:1; background:#fff; box-shadow:0 0 8px rgba(255,255,255,.8); }

  /* ===== Medal styles ===== */
  .medal{
    display:inline-grid; place-items:center;
    width:38px; height:38px; border-radius:50%;
    margin-right:8px; font-weight:1000; font-size:16px; line-height:1;
    border:1px solid rgba(0,0,0,.1);
    box-shadow: 0 6px 16px rgba(0,0,0,.08), inset 0 0 16px rgba(255,255,255,.35);
  }
  .gold  { background:linear-gradient(180deg,#ffe9a6,#f2c94c); color:#1a1a1a; }
  .silver{ background:linear-gradient(180deg,#f0f3f6,#cfd6e0); color:#1a1a1a; }
  .bronze{ background:linear-gradient(180deg,#f3c9a1,#c88a4a); color:#1a1a1a; }
  .rankwrap{ display:flex; align-items:center; justify-content:center; gap:6px; }

  /* ===== CoD Overlay (10s) ===== */
  #overlay.cod{position:fixed;inset:0;display:none;place-items:center;z-index:999;
    background: radial-gradient(900px 700px at 50% 40%, rgba(0,0,0,.2), rgba(0,0,0,.9) 60%, rgba(0,0,0,.96) 100%);}
  #overlay .burst{
    position:absolute; inset:0; pointer-events:none; opacity:.3;
    background:repeating-conic-gradient(from 0deg, rgba(245,214,107,.2) 0deg, transparent 6deg 12deg, rgba(245,214,107,.12) 18deg);
    mask: radial-gradient(ellipse at center, black 0%, transparent 60%);
    animation:spin 6s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  #card{
    position:relative; padding:calc(4*var(--vh)) calc(6*var(--vh)); border-radius:calc(2.2*var(--vh));
    background:linear-gradient(180deg, #0f1417, #141b1f);
    border:2px solid rgba(245,214,107,.55); color:#fff;
    text-align:center; animation:pop .45s ease-out;
    box-shadow:0 0 50px rgba(0,0,0,.6), inset 0 0 28px rgba(245,214,107,.10);
  }
  /* Badge del overlay con variantes */
  .badge{
    display:inline-grid; place-items:center;
    width:110px; height:110px; margin:0 auto calc(1.0*var(--vh));
    border-radius:50%;
    border:2px solid #d4b654;
    box-shadow:0 0 0 2px #1b1b1b, 0 12px 28px rgba(0,0,0,.45), inset 0 0 28px rgba(245,214,107,.18);
    color:#1a1a1a; font-weight:1000; font-size:40px; text-shadow:0 1px 0 #fff8;
    background: radial-gradient(circle at 50% 35%, #ffffff22, transparent 60%),
                linear-gradient(180deg, #f6e6a8, #e0b84a); /* default (star) */
  }
  .badge.gold{
    border-color:#e3c14e;
    background: radial-gradient(circle at 50% 35%, #ffffff22, transparent 60%),
                linear-gradient(180deg,#ffefb0,#f2c94c);
  }
  .badge.silver{
    border-color:#cfd6e0;
    background: radial-gradient(circle at 50% 35%, #ffffff22, transparent 60%),
                linear-gradient(180deg,#f4f7fb,#cfd6e0);
  }
  .badge.bronze{
    border-color:#c88a4a;
    background: radial-gradient(circle at 50% 35%, #ffffff22, transparent 60%),
                linear-gradient(180deg,#f7d1ad,#c88a4a);
  }
  #who{font:1000 calc(7.6*var(--vh))/1.02 system-ui;letter-spacing:.6px;margin-bottom:calc(.3*var(--vh));}
  #metaText{font:900 calc(2.4*var(--vh))/1.2 system-ui;margin-top:calc(.2*var(--vh)); color:#e9e1c1;}
  #rankLine{ margin-top:calc(.8*var(--vh)); font:1000 calc(3.6*var(--vh))/1 system-ui; display:flex; gap:12px; justify-content:center; align-items:center; }
  .delta{ font:1000 calc(2.0*var(--vh))/1 system-ui; padding:.2em .6em; border-radius:10px; border:1px solid rgba(255,255,255,.2); }
  .delta.up{ color:#2bd95f; }
  .delta.down{ color:#ff5757; }
  .position{ padding:.2em .6em; border-radius:10px; font-weight:1000; border:1px solid rgba(255,255,255,.25); color:#f5d66b; box-shadow:0 0 18px rgba(245,214,107,.25) inset; }

  @keyframes pop{from{transform:scale(.86);opacity:0}50%{transform:scale(1.02)}100%{transform:scale(1);opacity:1}}
  .confetti{position:absolute;top:-10vh;width:10px;height:16px;opacity:0;animation:fall 10s linear forwards}
  @keyframes fall{0%{transform:translateY(-10vh) rotate(0deg);opacity:0}10%{opacity:1}100%{transform:translateY(120vh) rotate(880deg);opacity:0}}
</style>
</head>
<body>
<div id='board'>
  <h2>üèÅ Leaderboard</h2>
  <div class='chips'>
    <div id='chipWeekly' class='chip'>Week: ‚Äî</div>
    <div id='chipDaily' class='chip'>Daily: ‚Äî</div>
  </div>

  <div class='table-wrap'>
    <table id='tbl'>
      <thead>
        <tr>
          <th class='col-rank'>#</th>
          <th class='col-agent'>Agent</th>
          <th class='col-today'>Today</th>
          <th class='col-day'>Wed</th>
          <th class='col-day'>Thu</th>
          <th class='col-day'>Fri</th>
          <th class='col-day'>Sat</th>
          <th class='col-day'>Mon</th>
          <th class='col-day'>Tue</th>
          <th class='col-total'>Total</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id='meta'>
    <div id='diag'>Loading‚Ä¶</div>
    <div class='dots' id='dots'></div>
  </div>
</div>

<!-- CoD Overlay (10s) sobre fondo verde -->
<div id='overlay' class='cod'>
  <div class='burst'></div>
  <div id='card'>
    <div class='badge'>‚òÖ</div>
    <div id='who'>Agent</div>
    <div id='metaText'>just passed ‚Äî today! üéâ</div>
    <div id='rankLine'>
      <span class='delta' id='deltaBadge'>‚ñ≤ +1</span>
      <span class='position' id='posBadge'>#1</span>
    </div>
  </div>
</div>

<script>
function setVHVar(){ const vh=window.innerHeight*0.01; document.documentElement.style.setProperty('--vh', `${vh}px`); }
setVHVar(); window.addEventListener('resize', setVHVar);

/* IDs y API */
const API_KEY        = "AIzaSyDwOqp2uizZol2et6Uqi7CnntW9Hkrinjg";
const WEEKLY_SHEETID = "xNrDZ6uXUS0XMU3033SALOPPORgyjQomH68W2GyTAUo";
const DAILY_ID_RAW   = "MeGKl3Qok84NymsXnuHuA4reL_l9Y1SqqLuejIMeaUA";

const TIMEZONE       = "America/Tijuana";
const PAGE_SIZE      = 10;
const PAGE_MS        = 45000;
const DAILY_REFRESH  = 12000;          // refresco m√°s frecuente
const WEEKLY_REFRESH = 5*60*1000;

let ALL_DATA=[]; let PAGE_INDEX=0;
let PREV_T=new Map(), PREV_R=new Map(), INITIALIZED=false;

function diag(t, cls){ document.getElementById('diag').innerHTML = `<span class="${cls||''}">${t}</span>`; }
function setChipWeekly(t){ document.getElementById('chipWeekly').textContent = `Week: ${t}`; }
function setChipDaily(t){ document.getElementById('chipDaily').textContent = `Daily: ${t}`; }
function getLocalDate(){ const s=new Date().toLocaleString('en-US',{timeZone:TIMEZONE}); return new Date(s); }
function isoWeek(d){ const x=new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); const n=x.getUTCDay()||7; x.setUTCDate(x.getUTCDate()+4-n); const y=new Date(Date.UTC(x.getUTCFullYear(),0,1)); return {week:Math.ceil((((x-y)/86400000)+1)/7), year:x.getUTCFullYear()}; }
function weeksInISOYear(y){ const d=new Date(Date.UTC(y,11,31)); const day=d.getUTCDay(); return (day===4 || (d.getUTCDate()===31 && day===3))?53:52; }
function computeWeeklyTabName(){
  const url=new URL(window.location.href); const override=url.searchParams.get('weeklyTab'); if(override) return override;
  const local=getLocalDate(); const hrs=local.getHours(); const dow=local.getDay(); const iw=isoWeek(local); let w=iw.week;
  const afterCut=(dow>4)||(dow===4&&hrs>=14); if(afterCut){ w++; const mx=weeksInISOYear(iw.year); if(w>mx){w=1;} }
  return `W${w}`;
}
const emoji=/[\u{1F1E6}-\u{1F1FF}\u{1F300}-\u{1FAFF}\u{1F900}-\u{1F9FF}\u{2600}-\u{27BF}\u{FE0F}]/gu;
function normName(s){ return (s||"").replace(emoji,"").normalize('NFD').replace(/[\u0300-\u036f]/g,"").replace(/[^\x20-\x7E]/g,"").replace(/\s{2,}/g," ").trim().toUpperCase(); }
function normID(s){ return (s||"").toString().trim(); }

/* fetch con cache-busting */
async function fetchSafeJSON(url, {tries=4, baseDelay=700} = {}) {
  let lastErr;
  for (let i = 0; i < tries; i++) {
    try {
      const r = await fetch(url, {
        cache: 'no-store',
        headers: {
          'Cache-Control': 'no-cache, no-store, max-age=0',
          'Pragma': 'no-cache'
        },
      });
      if (r.ok) return await r.json();

      const text = await r.text();
      if (r.status === 429 || (r.status >= 500 && r.status < 600)) {
        const jitter = Math.random() * 250;
        await new Promise(res => setTimeout(res, baseDelay * Math.pow(2, i) + jitter));
        continue;
      }
      throw new Error(`HTTP ${r.status} ‚Ä¢ ${text.slice(0,180)}`);
    } catch (e) {
      lastErr = e;
      const jitter = Math.random() * 250;
      await new Promise(res => setTimeout(res, baseDelay * Math.pow(2, i) + jitter));
    }
  }
  throw lastErr || new Error('fetchSafeJSON: unknown');
}
async function readWeeklyTab(weeklyTab){
  const ranges=[`${weeklyTab}!A3:C96`,`${
weeklyTab}!D3:D96`,`${
weeklyTab}!F3:F96`,`${
weeklyTab}!H3:H96`,`${
weeklyTab}!J3:J96`,`${
weeklyTab}!L3:L96`,`${
weeklyTab}!N3:N96`,`${
weeklyTab}!O3:O96`].map(encodeURIComponent);
  const url=`https://sheets.googleapis.com/v4/spreadsheets/${WEEKLY_SHEETID}/values:batchGet?`+ranges.map(r=>`ranges=${r}`).join("&")+`&valueRenderOption=UNFORMATTED_VALUE&key=${API_KEY}`;
  const j=await fetchSafeJSON(url); const vr=j.valueRanges||[];
  const base=vr[0]?.values||[]; const toCol=v=>(v?.values||[]).map(r=>(r[0]??"").toString().trim());
  const d=toCol(vr[1]), f=toCol(vr[2]), h=toCol(vr[3]), jv=toCol(vr[4]), l=toCol(vr[5]), n=toCol(vr[6]), oT=toCol(vr[7]);
  const len=Math.max(base.length,d.length,f.length,h.length,jv.length,l.length,n.length,oT.length);
  const out=[];
  for(let i=0;i<len;i++){
    const id=normID(base[i]?.[0]??""); const name=(base[i]?.[1]??"").toString().trim();
    if(!id && !name) continue;
    out.push({ id,idKey:id, name, nameKey:normName(name),
      wed:parseInt(d[i]||0), thu:parseInt(f[i]||0), fri:parseInt(h[i]||0),
      sat:parseInt(jv[i]||0), mon:parseInt(l[i]||0), tue:parseInt(n[i]||0),
      total:parseInt(oT[i]||0), today:0 });
  }
  out.sort((a,b)=>(b.total||0)-(a.total||0));
  return out;
}
function fmtDailyTab(dt){ const m=new Intl.DateTimeFormat('en-US',{month:'short',timeZone:TIMEZONE}).format(dt); const dd=new Intl.DateTimeFormat('en-US',{day:'2-digit',timeZone:TIMEZONE}).format(dt); return `${m} ${dd}`; }
function getDailyTabCandidates(){
  const url=new URL(window.location.href); const o=url.searchParams.get('dailyTab'); if(o) return [o];
  const now=getLocalDate(); const y=new Date(now.getTime()-86400000); return [fmtDailyTab(now), fmtDailyTab(y)];
}
async function readDailyApproved(){
  const rangesFor=tab=>([`${tab}!A2:A70`,`${tab}!B2:B70`,`${tab}!C2:C70`,`${tab}!E2:E70`,`${tab}!F2:F70`,`${tab}!G2:G70`].map(encodeURIComponent));
  const tabs=getDailyTabCandidates();
  const DAILY_IDS=[DAILY_ID_RAW];
  for(const id of DAILY_IDS){
    for(const tab of tabs){
      const url=`https://sheets.googleapis.com/v4/spreadsheets/${id}/values:batchGet?`+rangesFor(tab).map(r=>`ranges=${r}`).join("&")+`&valueRenderOption=UNFORMATTED_VALUE&key=${API_KEY}`;
      try{
        const j=await fetchSafeJSON(url); const vr=j.valueRanges||[];
        const A=vr[0]?.values||[], B=vr[1]?.values||[], C=vr[2]?.values||[];
        const E=vr[3]?.values||[], F=vr[4]?.values||[], G=vr[5]?.values||[];
        const mapByName=new Map(); const mapByID=new Map();
        function addPair(nmCell,idCell,valCell){
          const nm=(nmCell?.[0]??"").toString(); const id=(idCell?.[0]??"").toString().trim(); const v=parseInt((valCell?.[0]??0))||0;
          if(nm.trim()){ const nk=normName(nm); mapByName.set(nk,(mapByName.get(nk)||0)+v); }
          if(id){ mapByID.set(id,(mapByID.get(id)||0)+v); }
        }
        const rowsFK=Math.max(A.length,B.length,C.length); for(let i=0;i<rowsFK;i++) addPair(A[i],B[i],C[i]);
        const rowsRG=Math.max(E.length,F.length,G.length); for(let i=0;i<rowsRG;i++) addPair(E[i],F[i],G[i]);
        return {id, tab, mapByName, mapByID};
      }catch(e){ /* intenta siguiente tab */ }
    }
  }
  return {id:DAILY_IDS[0], tab:tabs[0], mapByName:new Map(), mapByID:new Map()};
}

function renderDots(total, activeIndex){
  const dots=document.getElementById('dots'); dots.innerHTML='';
  for(let i=0;i<total;i++){ const d=document.createElement('div'); d.className='dot'+(i===activeIndex?' on':''); dots.appendChild(d); }
}
function renderPage(list, pageIndex){
  const tbody=document.querySelector("#tbl tbody"); tbody.innerHTML="";
  const start=pageIndex*PAGE_SIZE; const page=list.slice(start, start+PAGE_SIZE);
  const maxToday=Math.max(1, ...page.map(p=>p.today||0)); const maxTotal=Math.max(1, ...page.map(p=>p.total||0));
  const toPct=(v,max)=>Math.max(3, Math.min(100, Math.round((v/max)*100)));
  page.forEach((p,i)=>{
    const rowIndex=start+i; const today=p.today||0, total=p.total||0;

    // celda rank con medallas para top 3 global (por Total)
    let medalHTML='';
    if (rowIndex===0) medalHTML = `<span class="medal gold" title="1st">ü•á</span>`;
    else if (rowIndex===1) medalHTML = `<span class="medal silver" title="2nd">ü•à</span>`;
    else if (rowIndex===2) medalHTML = `<span class="medal bronze" title="3rd">ü•â</span>`;

    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td class="col-rank">
        <div class="rankwrap">
          ${medalHTML}
          <span>${rowIndex+1}</span>
        </div>
      </td>
      <td class="col-agent">
        <div class="agent-wrap"><div class="avatar">${(p.name||'').split(' ').map(x=>x[0]||'').join('').slice(0,2).toUpperCase()}</div><div class="name" title="${p.name}">${p.name}</div></div>
      </td>
      <td class="col-today"><div class="bar today"><div class="fill" style="width:0%"></div><div class="value">${today}</div></div></td>
      <td class="col-day"><div class="spark"><div class="f" style="width:${toPct(p.wed||0,10)}%"></div>${p.wed||0}</div></td>
      <td class="col-day"><div class="spark"><div class="f" style="width:${toPct(p.thu||0,10)}%"></div>${p.thu||0}</div></td>
      <td class="col-day"><div class="spark"><div class="f" style="width:${toPct(p.fri||0,10)}%"></div>${p.fri||0}</div></td>
      <td class="col-day"><div class="spark"><div class="f" style="width:${toPct(p.sat||0,10)}%"></div>${p.sat||0}</div></td>
      <td class="col-day"><div class="spark"><div class="f" style="width:${toPct(p.mon||0,10)}%"></div>${p.mon||0}</div></td>
      <td class="col-day"><div class="spark"><div class="f" style="width:${toPct(p.tue||0,10)}%"></div>${p.tue||0}</div></td>
      <td class="col-total"><div class="bar total"><div class="fill" style="width:0%"></div><div class="value">${total}</div></div></td>`;
    tbody.appendChild(tr);
    requestAnimationFrame(()=>{
      tr.querySelector('.bar.today .fill').style.width = toPct(today, maxToday)+'%';
      tr.querySelector('.bar.total .fill').style.width = toPct(total, maxTotal)+'%';
    });
  });
  const totalPages=Math.max(1, Math.ceil(list.length/PAGE_SIZE)); renderDots(totalPages, Math.min(pageIndex,totalPages-1));
}

/* Overlay logic (CoD) */
const overlay=document.getElementById('overlay');
const whoEl=document.getElementById('who');
const metaTextEl=document.getElementById('metaText');
const deltaBadge=document.getElementById('deltaBadge');
const posBadge=document.getElementById('posBadge');

function spawnConfetti(){
  document.querySelectorAll('.confetti').forEach(e=>e.remove());
  const colors=['#f5d66b','#ffe08a','#ffffff','#2bd95f','#ff5757','#8dd9ff','#9aa6b2'];
  for(let i=0;i<140;i++){
    const d=document.createElement('div'); d.className='confetti';
    const size=5+Math.random()*12, left=Math.random()*100, delay=Math.random()*0.9, dur=8+Math.random()*6;
    d.style.left=left+'vw'; d.style.background=colors[Math.floor(Math.random()*colors.length)];
    d.style.width=size+'px'; d.style.height=(size*1.4)+'px';
    d.style.animationDuration=dur+'s'; d.style.animationDelay=delay+'s';
    d.style.transform=`translateY(-10vh) rotate(${(Math.random()*360).toFixed(1)}deg)`;
    overlay.appendChild(d); d.addEventListener('animationend', ()=>d.remove());
  }
}
function buildTodayRanking(list){
  const copy=list.map(p=>({nameKey:p.nameKey,name:p.name,today:p.today||0}));
  copy.sort((a,b)=>(b.today||0)-(a.today||0));
  const rankMap=new Map(); copy.forEach((p,i)=>rankMap.set(p.nameKey,i));
  return rankMap;
}
function showRankUp({name,newRank,delta,passedName}){
  whoEl.textContent = name;
  metaTextEl.textContent = passedName ? `just passed ${passedName} today!` : `is climbing today!`;

  posBadge.textContent = `#${newRank+1}`;
  deltaBadge.textContent = (delta>0? '‚ñ≤ +' : delta<0? '‚ñº -' : '‚Äî ') + Math.abs(delta||0);
  deltaBadge.className = 'delta ' + (delta>0? 'up':'down');

  // Medalla Top-3
  const badge = document.querySelector('.badge');
  badge.classList.remove('gold','silver','bronze');
  if (newRank === 0){ badge.classList.add('gold'); badge.textContent='ü•á'; }
  else if (newRank === 1){ badge.classList.add('silver'); badge.textContent='ü•à'; }
  else if (newRank === 2){ badge.classList.add('bronze'); badge.textContent='ü•â'; }
  else { badge.textContent='‚òÖ'; }

  overlay.style.display='grid';
  spawnConfetti();
  setTimeout(()=> overlay.style.display='none', 10000);
}
function detectAndCelebrate(list){
  const CUR_RANK=buildTodayRanking(list);
  let best=null;
  list.forEach(p=>{
    const key=p.nameKey; const prev=(PREV_T.get(key)||0); const cur=(p.today||0);
    const inc=cur - prev;
    if(inc>0){
      const pr=PREV_R.has(key)?PREV_R.get(key):Number.POSITIVE_INFINITY;
      const nr=CUR_RANK.get(key);
      let passed=null;
      if(nr<pr){
        for(let i=nr+1;i<=pr && i<list.length;i++){
          const behind=list.find(x=>CUR_RANK.get(x.nameKey)===i);
          if(behind){ passed=behind.name; break; }
        }
      }
      const delta=(pr===Number.POSITIVE_INFINITY)?0:(pr-nr);
      const ev={name:p.name,newRank:nr,delta,passedName:passed,inc};
      if(!best || ev.inc>best.inc || (ev.inc===best.inc && ev.newRank<best.newRank)) best=ev;
    }
  });
  PREV_T.clear(); PREV_R.clear();
  list.forEach(p=>{ PREV_T.set(p.nameKey,p.today||0); PREV_R.set(p.nameKey, CUR_RANK.get(p.nameKey)); });
  if(best) showRankUp(best);
}

async function getWeeklyCached(weeklyTab, ttl=WEEKLY_REFRESH){
  const Cache=window.__cacheW||(window.__cacheW={at:0,tab:null,data:null});
  if(Cache.data && Cache.tab===weeklyTab && (Date.now()-Cache.at)<ttl) return Cache.data;
  const data=await readWeeklyTab(weeklyTab); window.__cacheW={at:Date.now(),tab:weeklyTab,data}; return data;
}
async function getDailyCached(ttl=DAILY_REFRESH-1000){
  const Cache=window.__cacheD||(window.__cacheD={at:0,tab:null,data:null});
  if(Cache.data && (Date.now()-Cache.at)<ttl) return Cache.data;
  const data=await readDailyApproved(); window.__cacheD={at:Date.now(),tab:data.tab,data}; return data;
}
async function refreshWeekly(){
  try{
    const weeklyTab=computeWeeklyTabName(); setChipWeekly(weeklyTab);
    ALL_DATA=await getWeeklyCached(weeklyTab,WEEKLY_REFRESH);
    diag(`Weekly OK (${weeklyTab}) ‚Ä¢ ${ALL_DATA.length} agents`,'ok');
  }catch(e){ diag('Weekly error: '+(e.message||e),'err'); }
}
async function refreshDaily(){
  try{
    const {id,tab,mapByName,mapByID}=await getDailyCached(DAILY_REFRESH);
    setChipDaily(tab);
    if(!ALL_DATA.length){ await refreshWeekly(); if(!ALL_DATA.length) return; }
    ALL_DATA.forEach(p=>{
      const vID=mapByID.get(p.idKey), vNM=mapByName.get(p.nameKey);
      p.today = (typeof vID==='number' && !Number.isNaN(vID)) ? vID :
                (typeof vNM==='number' && !Number.isNaN(vNM)) ? vNM : 0;
    });
    if(INITIALIZED){ detectAndCelebrate(ALL_DATA); }
    else {
      const r=buildTodayRanking(ALL_DATA);
      ALL_DATA.forEach(p=>{ PREV_T.set(p.nameKey,p.today||0); PREV_R.set(p.nameKey, r.get(p.nameKey)); });
      INITIALIZED=true;
    }
    diag(`Daily OK (${tab})`,'ok');
  }catch(e){ diag('Daily error: '+(e.message||e),'err'); }
}
function rotatePage(){
  if(!ALL_DATA.length) return;
  const totalPages=Math.max(1, Math.ceil(ALL_DATA.length/PAGE_SIZE));
  PAGE_INDEX=PAGE_INDEX%totalPages;
  renderPage(ALL_DATA,PAGE_INDEX);
  renderDots(totalPages, PAGE_INDEX);
  PAGE_INDEX=(PAGE_INDEX+1)%totalPages;
}
(async function start(){
  await refreshWeekly();
  await refreshDaily();
  rotatePage();
  setInterval(refreshWeekly, WEEKLY_REFRESH);
  setInterval(refreshDaily,  DAILY_REFRESH);
  setInterval(rotatePage,    PAGE_MS);
})();
</script>
</body>
</html>





